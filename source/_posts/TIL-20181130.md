---
title: TIL-20181130
subtitle: 개인 앱에 테스트 코드 작성하기 / 다음 개인 앱을 위한 Firebase 공부 시작
date: 2018-11-30 00:41:14
tags: ["TIL", "Unit Test", "Firebase"]
category: ["TIL"]
---

#### 유닛테스트

드디어 GitBingo의 첫 단위 테스트 코드를 작성하였다. 사실 첫 단위 테스트는 아니다. 스스로 그나마 만족할만한 단위 테스트 코드를 작성하였다. 네트워크 매니저를 통해 API를 호출하는 Presenter의 단위 테스트 코드를 작성해야 하는데 네트워크 매니저가 싱글톤으로 구현되어 있었고 Presenter가 이 싱글톤에 강하게 의존하고 있어 테스트 코드 작성이 쉽지 않았다. 가장 먼저 싱글톤의 형태의 네트워크 매니저를 추상화 등의 리팩토링하고 이를  Presenter에 Injection 해주었다. 그리고 리팩토링을 과정에서 만들어진 프로토콜을 이용해 Mock 객체를 사용하여 테스트 코드를 작성할 수 있었다. 

총 세 개의 Mock 객체를 정의해주었는데 네트워크 매니저 역할의 객체, 네트워크 요청 시 대체할 수 있는 세션 객체 그리고 Presenter가 갱신하는 뷰 객체였다. Presenter를 테스트하기 위해 Presenter는 실제 사용 중인 Presenter를 사용했고 이렇게 만들어진 Mock 객체들을 주입하여 테스트를 진행하였다. 

**어려움을 겪었던 부분**

네트워크 매니저 테스트는 그리 힘들지 않았다. 하지만 Presenter 내부에서 `DispatchQueue.main.async { code }` 가 존재하였고 해당 코드 블럭안에서 뷰 갱신을 위한 프로토콜 메소드들을 호출해주는데 비동기로 작동하여 Presenter 테스트에 어려움을 겪었다. `expectation` 을 사용해보려 하였으나 Presenter는 실제 사용 중인 객체였으므로 불가능하였고 고심 끝에 `DispatchQueue.main.async { code }`를 아예 프로토콜 메소드 안에서 구현해주어 테스트를 진행하였다. 이렇게 진행하니 테스트를 수행할 수 있었다. 

> 테스트 코드 작성에 많이 서툽니다. 틀리거나 부족한 부분 혹은 더 좋은 방법이 있다면 피드백 부탁드립니다.

*기존*

```swift
class MainViewPresenter {
    private weak var vc: MainViewProtocol?
    private var service: NetworkService
    
    init(_ service: NetworkService) {
        self.service = service
    }
    
    func attatchVC(_ vc: MainViewProtocol) {
        self.vc = vc
    }
    
    func request(id: String) {
        service.fetch(id) { (contributions, error) in
            if let error = error {
                DispatchQueue.main.async {
                    // 비동기로 테스트 진행시 바로 넘어가버림.
                    self.vc.showAlert(error)    
                }
                return
            }
            DispatchQueue.main.async {
                // 비동기로 테스트 진행시 바로 넘어가버림.
                self.vc.update()
            }              
        }
    }
}
```

*현재*

```swift
class MainViewPresenter {
    ...
    func request(id: String) {
        service.fetch(id) { (contributions, error) in
            if let error = error {
                self.vc.showAlert(error)    
                return
            }
            self.vc.update()           
        }
    }
}

class MainViewController {
    ...
}

extension MainViewController: MainViewProtocol {
    func showAlert(_ error: Error) {
        DispatchQueue.main.async {
            // Alert
        }
    }
    
    func update() {
        DispatchQueue.main.async {
            // Update
        }
    }
}
```

[레포지토리](https://github.com/ehdrjsdlzzzz/GitBingo/tree/develop)

------

#### Firebase 

예전부터 계획해오던 개인 앱이 있었다. 하지만 푸시 알람이 필수적이고 이를 위해선 Firebase의 주제/구독 기능을 사용해야 했다. 하지만 문서를 정독해도 이를 코드로 옮기고 원하는 기능을 완벽히 구현하기에는 부족했고 해당 기능에 대한 튜토리얼도 찾아보기 힘들었으나 같이 공부하고 있는 분께서 예전에 결제해놓은 해외 강의 영상에 해당 내용이 있다는 것을 알려주셔서 해당 영상을 시청하고 있다. 

해당 영상은 인스타그램 클론 강의인데 이곳에서 좋아요, 팔로우 그리고 댓글 작성이 발생하였을 때 알람이 오는데 이를 주제/구독으로 구현해놓았다. 이를 통해 예전부터 계획해오던 개인 앱 제작에 한 발 더 다가설 수 있게 되었다.

> 해당 강의는 [Letsbuildthatapp](https://www.letsbuildthatapp.com/course/Instagram-Firebase)에서 확인할 수 있다.

현재는 이메일을 통한 회원가입 그리고 사용자 UID를 키값으로 사용해 닉네임과 프로필 사진 저장소 URL을 저장하는 등 흥미로운 것들을 알아가고 있다. 생각보다 사용법도 굉장히 간단하여 쉽게 익힐 수 있을 것 같다. 